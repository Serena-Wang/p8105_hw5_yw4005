---
title: "P8105 HW5"
author: "Yijin Serena Wang"
date: "`r Sys.Date()`"
output: github_document
---

```{r, message = FALSE}
library(tidyverse)
library(purrr)
library(readr)
library(janitor)
library(broom)
library(stats)
library(ggplot2)
```


## Problem 1
```{r, message = FALSE}
file_paths <- list.files("./p1_data", full.names = TRUE)
participant_data <- tibble(file_name = str_replace(file_paths, "./p1_data/","")) %>%
  mutate(data = map(.x = file_paths, ~read_csv(file = .x)))
```

```{r}
participant_data <- participant_data %>%
  mutate(file_name = str_replace(file_name, ".csv","")) %>%
  unnest(data) %>%
  clean_names() %>%
  separate(col = c(file_name),
           sep = "_",
           into = c("arm", "id")) %>%
  mutate(arm  = ifelse(arm == "exp", "experimental", "control")) %>%
  pivot_longer(cols = starts_with("week_"),
               names_to = "week",
               values_to = "value") %>%
  mutate(week = str_replace(week, "week_",""),
         week = as.numeric(week))
```

```{r}
head(participant_data)
```


```{r spaghetti plot}
participant_data %>%
  ggplot(aes(x = week, y = value, color = interaction(id, arm))) +
  geom_line() +
  facet_grid(.~arm) +
  theme(legend.position = "bottom")+
  labs(color = "id with arm",
       title = "Comparison of weekly observation in each arm")

```

All subjects in the experimental arm have a clear upward trend in their weekly measurement over time. On the other hand, all subjects in the control arm have small fluctuations around their initial measurement.

## Problem 2

The raw data contains information about criminal homicides in the last 10 years in the US. It includes 52179 observations. They have victim's information, specific location of homicide, whether an arrest was made.
```{r}
homicide_data <- read_csv("./p2_data/homicide-data.csv") %>%
  mutate(city_state = paste0(city, ", ", state)) %>%
  clean_names() 
```

```{r}
homicide_summary <- homicide_data %>%
  group_by(city_state) %>%
  summarise(total_number_of_homicides = n(),
            number_of_unsolved_homicides = sum(disposition %in% c("Closed without arrest", "Open/No arrest"))) 

homicide_summary %>%
  knitr::kable(digits = 1)
```

```{r baltimore_prop}
baltimore_unsolved_test <- 
  prop.test(
  x = homicide_summary %>% 
    filter(city_state == "Baltimore, MD") %>%
    pull(number_of_unsolved_homicides),
  n = homicide_summary %>% 
    filter(city_state == "Baltimore, MD") %>%
    pull(total_number_of_homicides))

baltimore_unsolved_test %>% 
  tidy() %>%
  knitr::kable(digits = 5)
```
With  95% confidence level, estimated proportion is 0.6455607 and estimated confidence interval is (0.6275625, 0.6631599).

```{r all_prop}
prop_test_results <- map2(
  .y  = homicide_summary$total_number_of_homicides,
  .x = homicide_summary$number_of_unsolved_homicides,
  ~prop.test(x = .x, n = .y) %>%
    tidy()
)

prop_test_results <- homicide_summary %>%
  mutate(results = prop_test_results) %>%
  unnest(results)
```

```{r}
head(prop_test_results) %>%
  knitr::kable(digits = 3)
  
```

```{r error_bar_plot}
prop_test_results %>%
  ggplot(aes(group = city_state, x = reorder(city_state, estimate))) + 
  geom_point(aes(y = estimate)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  labs(x = "City state", y = "Estimated % of unsolved homicides")
  
```


## Problem 3

```{r}
set.seed(1)
n <- 30
sigma <-  5
mu  <- 0
```

```{r}
sim_normal <- function(n, mu, sigma) {
  
  sim_data = tibble(
    x = rnorm(n, mean = mu, sd = sigma),
  )
  
  sim_data %>% 
    summarize(
      mu_hat = mean(x),
      p_value = t.test(x, mu = 0, conf.level = 1-0.05) %>%
        tidy() %>%
        pull(p.value)
    )
}
```

```{r}
sim_results_df = 
  expand_grid(
    sample_size = n,
    sigma = sigma,
    mu =  mu,
    iter = 1:5000
  ) %>% 
  mutate(
    estimate_df = pmap(list(sample_size, mu, sigma), sim_normal)
  ) %>% 
  unnest(estimate_df)
```

```{r}
mu <- 1:6


```

